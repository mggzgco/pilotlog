generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  DISABLED
}

enum FlightStatus {
  PLANNED
  PREFLIGHT_SIGNED
  POSTFLIGHT_IN_PROGRESS
  POSTFLIGHT_SIGNED
  IMPORTED
  COMPLETED
}

enum AutoImportStatus {
  NONE
  RUNNING
  MATCHED
  AMBIGUOUS
  NOT_FOUND
  FAILED
}

enum ChecklistPhase {
  PREFLIGHT
  POSTFLIGHT
}

enum ChecklistInputType {
  CHECK
  YES_NO
  NUMBER
  TEXT
}

enum ChecklistItemKind {
  SECTION
  STEP
}

enum ChecklistRunStatus {
  NOT_AVAILABLE
  IN_PROGRESS
  SIGNED
}

enum ChecklistDecision {
  ACCEPTED
  REJECTED
}

enum FlightParticipantRole {
  INSTRUCTOR
  STUDENT
  PIC
  SIC
}

enum LogbookEntryStatus {
  OPEN
  CLOSED
}

enum AircraftCategory {
  SINGLE_ENGINE_PISTON
  MULTI_ENGINE_PISTON
  SINGLE_ENGINE_TURBINE
  MULTI_ENGINE_TURBINE
  JET
  GLIDER
  HELICOPTER
  OTHER
}

model User {
  id                 String                 @id @default(cuid())
  email              String                 @unique
  firstName          String?
  lastName           String?
  name               String?
  phone              String?
  homeAirport        String?
  homeTimeZone       String?
  passwordHash       String
  status             UserStatus             @default(PENDING)
  role               UserRole               @default(USER)
  createdAt          DateTime               @default(now())
  sessions           Session[]
  flights            Flight[]
  people             Person[]
  aircraft           Aircraft[]
  aircraftTypes      AircraftType[]
  logbook            LogbookEntry[]
  costItems          CostItem[]
  flightParticipants FlightParticipant[]
  resetTokens        PasswordResetToken[]
  approvalTokens     AccountApprovalToken[]
  receiptDocuments   ReceiptDocument[]
  auditEvents        AuditEvent[]
  checklistTemplates ChecklistTemplate[]
  checklistSignoffs  FlightChecklistRun[]   @relation("ChecklistRunSignedBy")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Flight {
  id                  String               @id @default(cuid())
  userId              String
  aircraftId          String?
  tailNumber          String
  tailNumberSnapshot  String?
  origin              String
  originAirportId     String?
  destination         String?
  destinationAirportId String?
  stops               FlightStop[]
  status              FlightStatus         @default(PLANNED)
  plannedStartTime    DateTime?
  plannedEndTime      DateTime?
  startTime           DateTime
  endTime             DateTime?
  durationMinutes     Int?
  distanceNm          Int?
  routePolyline       String?
  statsJson           Json?
  importedProvider    String?
  providerFlightId    String?
  autoImportStatus    AutoImportStatus?
  autoImportLastError String?
  createdAt           DateTime             @default(now())
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  aircraft            Aircraft?            @relation(fields: [aircraftId], references: [id], onDelete: SetNull)
  originAirport       Airport?             @relation("FlightOriginAirport", fields: [originAirportId], references: [id], onDelete: SetNull)
  destinationAirport  Airport?             @relation("FlightDestinationAirport", fields: [destinationAirportId], references: [id], onDelete: SetNull)
  logbookEntries      LogbookEntry[]
  participants        FlightParticipant[]
  peopleParticipants  FlightPersonParticipant[]
  costItems           CostItem[]
  trackPoints         TrackPoint[]
  checklistRuns       FlightChecklistRun[]
  receiptDocuments    ReceiptDocument[]

  @@unique([userId, importedProvider, providerFlightId])
  @@index([aircraftId])
  @@index([originAirportId])
  @@index([destinationAirportId])
}

model FlightStop {
  id        String   @id @default(cuid())
  flightId  String
  order     Int
  label     String
  airportId String?
  createdAt DateTime @default(now())

  flight    Flight  @relation(fields: [flightId], references: [id], onDelete: Cascade)
  airport   Airport? @relation(fields: [airportId], references: [id], onDelete: SetNull)

  @@unique([flightId, order])
  @@index([flightId])
  @@index([airportId])
}

model Airport {
  id        String   @id @default(cuid())
  icao      String   @unique
  iata      String?
  name      String?
  city      String?
  region    String?
  country   String?
  latitude  Float?
  longitude Float?
  timeZone  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  originFlights      Flight[] @relation("FlightOriginAirport")
  destinationFlights Flight[] @relation("FlightDestinationAirport")

  @@index([iata])
  @@index([timeZone])
}

model FlightParticipant {
  id        String               @id @default(cuid())
  flightId  String
  userId    String
  role      FlightParticipantRole
  createdAt DateTime             @default(now())
  flight    Flight               @relation(fields: [flightId], references: [id], onDelete: Cascade)
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flightId, userId])
  @@index([flightId])
  @@index([userId])
}

model FlightPersonParticipant {
  id        String               @id @default(cuid())
  flightId  String
  personId  String
  role      FlightParticipantRole
  createdAt DateTime             @default(now())
  flight    Flight               @relation(fields: [flightId], references: [id], onDelete: Cascade)
  person    Person               @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([flightId, personId])
  @@index([flightId])
  @@index([personId])
}

model Person {
  id        String                     @id @default(cuid())
  userId    String
  name      String
  email     String?
  phone     String?
  createdAt DateTime                   @default(now())
  user      User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  flights   FlightPersonParticipant[]

  @@index([userId])
}

model Aircraft {
  id                            String             @id @default(cuid())
  userId                        String
  aircraftTypeId                String?
  tailNumber                    String
  manufacturer                  String?
  model                         String?
  category                      AircraftCategory   @default(OTHER)
  photoStoragePath              String?
  photoOriginalFilename         String?
  photoContentType              String?
  photoSizeBytes                Int?
  preflightChecklistTemplateId  String?
  postflightChecklistTemplateId String?
  createdAt                     DateTime           @default(now())
  user                          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  aircraftType                  AircraftType?      @relation(fields: [aircraftTypeId], references: [id], onDelete: SetNull)
  preflightChecklistTemplate    ChecklistTemplate? @relation("AircraftPreflightChecklist", fields: [preflightChecklistTemplateId], references: [id], onDelete: SetNull)
  postflightChecklistTemplate   ChecklistTemplate? @relation("AircraftPostflightChecklist", fields: [postflightChecklistTemplateId], references: [id], onDelete: SetNull)
  flights                       Flight[]

  @@unique([userId, tailNumber])
  @@index([aircraftTypeId])
  @@index([preflightChecklistTemplateId])
  @@index([postflightChecklistTemplateId])
}

model AircraftType {
  id                          String             @id @default(cuid())
  userId                      String
  name                        String
  defaultPreflightTemplateId  String?
  defaultPostflightTemplateId String?
  createdAt                   DateTime           @default(now())
  user                        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  aircraft                    Aircraft[]
  defaultPreflightTemplate    ChecklistTemplate? @relation("AircraftTypePreflightChecklist", fields: [defaultPreflightTemplateId], references: [id], onDelete: SetNull)
  defaultPostflightTemplate   ChecklistTemplate? @relation("AircraftTypePostflightChecklist", fields: [defaultPostflightTemplateId], references: [id], onDelete: SetNull)

  @@unique([userId, name])
  @@index([userId])
  @@index([defaultPreflightTemplateId])
  @@index([defaultPostflightTemplateId])
}

model LogbookEntry {
  id             String   @id @default(cuid())
  userId         String
  flightId       String?
  date           DateTime
  status         LogbookEntryStatus @default(OPEN)
  tailNumberSnapshot String?
  origin         String?
  destination    String?
  timeOut        String?
  timeIn         String?
  hobbsOut       Decimal? @db.Decimal(7, 2)
  hobbsIn        Decimal? @db.Decimal(7, 2)
  totalTime      Decimal? @db.Decimal(5, 2)
  picTime        Decimal? @db.Decimal(5, 2)
  sicTime        Decimal? @db.Decimal(5, 2)
  dualReceivedTime Decimal? @db.Decimal(5, 2)
  soloTime       Decimal? @db.Decimal(5, 2)
  nightTime      Decimal? @db.Decimal(5, 2)
  xcTime         Decimal? @db.Decimal(5, 2)
  simulatedInstrumentTime Decimal? @db.Decimal(5, 2)
  instrumentTime Decimal? @db.Decimal(5, 2) // actual instrument
  simulatorTime  Decimal? @db.Decimal(5, 2)
  groundTime     Decimal? @db.Decimal(5, 2)
  dayTakeoffs    Int?
  dayLandings    Int?
  nightTakeoffs  Int?
  nightLandings  Int?
  externalSource String?
  externalId     String?
  externalFingerprint String?
  externalUpdatedAt DateTime?
  remarks        String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  flight         Flight?  @relation(fields: [flightId], references: [id], onDelete: SetNull)

  @@index([userId, date])
  @@index([userId, tailNumberSnapshot])
  @@unique([userId, externalSource, externalId])
}

model CostItem {
  id          String   @id @default(cuid())
  userId      String
  flightId    String?
  category    String
  rateCents   Int?
  quantityHours Decimal? @db.Decimal(7, 2)
  fuelGallons Decimal? @db.Decimal(7, 2)
  fuelPriceCents Int?
  amountCents Int
  vendor      String?
  notes       String?
  date        DateTime
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  flight      Flight?  @relation(fields: [flightId], references: [id], onDelete: SetNull)
  receipts    ReceiptDocument[]

  @@map("Cost")
}

model ReceiptDocument {
  id               String     @id @default(cuid())
  userId           String
  flightId         String
  costItemId       String?
  originalFilename String
  storagePath      String
  contentType      String?
  sizeBytes        Int?
  createdAt        DateTime   @default(now())
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  flight           Flight     @relation(fields: [flightId], references: [id], onDelete: Cascade)
  costItem         CostItem?  @relation(fields: [costItemId], references: [id], onDelete: SetNull)
}

model TrackPoint {
  id            String   @id @default(cuid())
  flightId      String
  recordedAt    DateTime
  latitude      Float
  longitude     Float
  altitudeFeet  Int?
  groundspeedKt Int?
  headingDeg    Int?
  flight        Flight   @relation(fields: [flightId], references: [id], onDelete: Cascade)

  @@index([flightId, recordedAt])
}

model AuditEvent {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
}

model AccountApprovalToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChecklistTemplate {
  id                String                @id @default(cuid())
  userId            String?
  name              String
  phase             ChecklistPhase
  isDefault         Boolean               @default(false)
  makeModel         String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  user              User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  items             ChecklistTemplateItem[]
  aircraftPreflightTemplates  Aircraft[]           @relation("AircraftPreflightChecklist")
  aircraftPostflightTemplates Aircraft[]           @relation("AircraftPostflightChecklist")
  aircraftTypePreflightDefaults  AircraftType[]    @relation("AircraftTypePreflightChecklist")
  aircraftTypePostflightDefaults AircraftType[]    @relation("AircraftTypePostflightChecklist")

  @@index([phase, isDefault])
}

model ChecklistTemplateItem {
  id         String             @id @default(cuid())
  templateId String
  // Legacy flat ordering (kept for backwards compatibility). New logic should use
  // `officialOrder` / `personalOrder`.
  order      Int
  kind       ChecklistItemKind  @default(STEP)
  parentId   String?
  officialOrder Int            @default(0)
  personalOrder Int            @default(0)
  title      String
  itemLabel  String?
  acceptanceCriteria String?
  details    String?
  required   Boolean            @default(true)
  inputType  ChecklistInputType @default(CHECK)
  template   ChecklistTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  parent     ChecklistTemplateItem? @relation("ChecklistTemplateItemHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   ChecklistTemplateItem[] @relation("ChecklistTemplateItemHierarchy")
}

model FlightChecklistRun {
  id                 String              @id @default(cuid())
  flightId           String
  phase              ChecklistPhase
  status             ChecklistRunStatus  @default(IN_PROGRESS)
  decision           ChecklistDecision?
  decisionNote       String?
  startedAt          DateTime?
  signedAt           DateTime?
  signedByUserId     String?
  signatureName      String?
  signatureIp        String?
  signatureUserAgent String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  flight             Flight              @relation(fields: [flightId], references: [id], onDelete: Cascade)
  signedByUser       User?               @relation("ChecklistRunSignedBy", fields: [signedByUserId], references: [id], onDelete: SetNull)
  items              FlightChecklistItem[]

  @@unique([flightId, phase])
}

model FlightChecklistItem {
  id             String             @id @default(cuid())
  checklistRunId String
  order          Int
  kind           ChecklistItemKind  @default(STEP)
  parentId       String?
  officialOrder  Int                @default(0)
  personalOrder  Int                @default(0)
  title          String
  itemLabel      String?
  acceptanceCriteria String?
  details        String?
  required       Boolean
  inputType      ChecklistInputType
  completed      Boolean            @default(false)
  valueText      String?
  valueNumber    Float?
  valueYesNo     Boolean?
  notes          String?
  completedAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  checklistRun   FlightChecklistRun @relation(fields: [checklistRunId], references: [id], onDelete: Cascade)

  parent         FlightChecklistItem? @relation("FlightChecklistItemHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children       FlightChecklistItem[] @relation("FlightChecklistItemHierarchy")

  @@index([checklistRunId, order])
}
