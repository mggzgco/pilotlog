generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  DISABLED
}

enum FlightStatus {
  PLANNED
  PREFLIGHT_SIGNED
  POSTFLIGHT_IN_PROGRESS
  POSTFLIGHT_SIGNED
  IMPORTED
  COMPLETED
}

enum AutoImportStatus {
  NONE
  RUNNING
  MATCHED
  AMBIGUOUS
  NOT_FOUND
  FAILED
}

enum ChecklistPhase {
  PREFLIGHT
  POSTFLIGHT
}

enum ChecklistInputType {
  CHECK
  YES_NO
  NUMBER
  TEXT
}

enum ChecklistRunStatus {
  NOT_AVAILABLE
  IN_PROGRESS
  SIGNED
}

model User {
  id                 String                 @id @default(cuid())
  email              String                 @unique
  firstName          String?
  lastName           String?
  name               String?
  phone              String?
  passwordHash       String
  status             UserStatus             @default(PENDING)
  role               UserRole               @default(USER)
  createdAt          DateTime               @default(now())
  sessions           Session[]
  flights            Flight[]
  aircraft           Aircraft[]
  logbook            LogbookEntry[]
  costItems          CostItem[]
  resetTokens        PasswordResetToken[]
  approvalTokens     AccountApprovalToken[]
  receiptDocuments   ReceiptDocument[]
  auditEvents        AuditEvent[]
  checklistTemplates ChecklistTemplate[]
  checklistSignoffs  FlightChecklistRun[]   @relation("ChecklistRunSignedBy")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Flight {
  id                  String               @id @default(cuid())
  userId              String
  tailNumber          String
  tailNumberSnapshot  String?
  origin              String
  destination         String?
  status              FlightStatus         @default(PLANNED)
  plannedStartTime    DateTime?
  plannedEndTime      DateTime?
  startTime           DateTime
  endTime             DateTime?
  durationMinutes     Int?
  distanceNm          Int?
  routePolyline       String?
  statsJson           Json?
  importedProvider    String?
  providerFlightId    String?
  autoImportStatus    AutoImportStatus?
  autoImportLastError String?
  createdAt           DateTime             @default(now())
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  logbookEntries      LogbookEntry[]
  costItems           CostItem[]
  trackPoints         TrackPoint[]
  checklistRuns       FlightChecklistRun[]
  receiptDocuments    ReceiptDocument[]

  @@unique([userId, importedProvider, providerFlightId])
}

model Aircraft {
  id         String   @id @default(cuid())
  userId     String
  tailNumber String
  model      String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tailNumber])
}

model LogbookEntry {
  id             String   @id @default(cuid())
  userId         String
  flightId       String?
  date           DateTime
  totalTime      Decimal? @db.Decimal(5, 2)
  picTime        Decimal? @db.Decimal(5, 2)
  sicTime        Decimal? @db.Decimal(5, 2)
  nightTime      Decimal? @db.Decimal(5, 2)
  instrumentTime Decimal? @db.Decimal(5, 2)
  remarks        String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  flight         Flight?  @relation(fields: [flightId], references: [id], onDelete: SetNull)
}

model CostItem {
  id          String   @id @default(cuid())
  userId      String
  flightId    String?
  category    String
  amountCents Int
  vendor      String?
  notes       String?
  date        DateTime
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  flight      Flight?  @relation(fields: [flightId], references: [id], onDelete: SetNull)
  receipts    ReceiptDocument[]

  @@map("Cost")
}

model ReceiptDocument {
  id               String     @id @default(cuid())
  userId           String
  flightId         String
  costItemId       String?
  originalFilename String
  storagePath      String
  contentType      String?
  sizeBytes        Int?
  createdAt        DateTime   @default(now())
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  flight           Flight     @relation(fields: [flightId], references: [id], onDelete: Cascade)
  costItem         CostItem?  @relation(fields: [costItemId], references: [id], onDelete: SetNull)
}

model TrackPoint {
  id            String   @id @default(cuid())
  flightId      String
  recordedAt    DateTime
  latitude      Float
  longitude     Float
  altitudeFeet  Int?
  groundspeedKt Int?
  headingDeg    Int?
  flight        Flight   @relation(fields: [flightId], references: [id], onDelete: Cascade)

  @@index([flightId, recordedAt])
}

model AuditEvent {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
}

model AccountApprovalToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChecklistTemplate {
  id                String                @id @default(cuid())
  userId            String?
  name              String
  phase             ChecklistPhase
  isDefault         Boolean               @default(false)
  aircraftTailNumber String?
  makeModel         String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  user              User?                 @relation(fields: [userId], references: [id], onDelete: SetNull)
  items             ChecklistTemplateItem[]

  @@index([phase, isDefault])
  @@index([aircraftTailNumber])
}

model ChecklistTemplateItem {
  id         String             @id @default(cuid())
  templateId String
  order      Int
  title      String
  details    String?
  required   Boolean            @default(true)
  inputType  ChecklistInputType @default(CHECK)
  template   ChecklistTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
}

model FlightChecklistRun {
  id                 String              @id @default(cuid())
  flightId           String
  phase              ChecklistPhase
  status             ChecklistRunStatus  @default(IN_PROGRESS)
  startedAt          DateTime?
  signedAt           DateTime?
  signedByUserId     String?
  signatureName      String?
  signatureIp        String?
  signatureUserAgent String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  flight             Flight              @relation(fields: [flightId], references: [id], onDelete: Cascade)
  signedByUser       User?               @relation("ChecklistRunSignedBy", fields: [signedByUserId], references: [id], onDelete: SetNull)
  items              FlightChecklistItem[]

  @@unique([flightId, phase])
}

model FlightChecklistItem {
  id             String             @id @default(cuid())
  checklistRunId String
  order          Int
  title          String
  details        String?
  required       Boolean
  inputType      ChecklistInputType
  completed      Boolean            @default(false)
  valueText      String?
  valueNumber    Float?
  valueYesNo     Boolean?
  notes          String?
  completedAt    DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  checklistRun   FlightChecklistRun @relation(fields: [checklistRunId], references: [id], onDelete: Cascade)

  @@index([checklistRunId, order])
}
